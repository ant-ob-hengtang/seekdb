#!/bin/bash

#!/bin/bash

# OceanBase start script
# This script reads configuration from /etc/oceanbase/oceanbase.cnf and starts observer

CONFIG_FILE="/etc/oceanbase/oceanbase.cnf"
BASE_DIR="/var/lib/oceanbase"

# Check if config file exists
if [ ! -f "$CONFIG_FILE" ]; then
    echo "Error: Configuration file $CONFIG_FILE not found"
    exit 1
fi

# Variables to store data-dir path
DATA_DIR="/var/lib/oceanbase/store"

# Initialize additional parameters
ADDITIONAL_PARAMS=""

# Read configuration file and build command line arguments
while IFS= read -r line; do
    # Skip empty lines and comments
    [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue

    key="${line%%=*}"
    value="${line#*=}"

    # Trim whitespace
    key="$(echo "$key" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')"
    value="$(echo "$value" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')"

    case "$key" in
        "port")
            ADDITIONAL_PARAMS="$ADDITIONAL_PARAMS --port=$value"
            ;;
        "base-dir")
            BASE_DIR="$value"
            ;;
        "data-dir")
            ADDITIONAL_PARAMS="$ADDITIONAL_PARAMS --data-dir=$value"
            DATA_DIR="$value"
            ;;
        "redo-dir")
            ADDITIONAL_PARAMS="$ADDITIONAL_PARAMS --redo-dir=$value"
            ;;
        *)
            ADDITIONAL_PARAMS="$ADDITIONAL_PARAMS --parameter $key=$value"
            ;;
    esac
done < "$CONFIG_FILE"

# Build final command
CMD="/usr/bin/observer --initialize --base-dir=$BASE_DIR $ADDITIONAL_PARAMS"

echo "Starting OceanBase with command: $CMD"
echo "Configuration loaded from: $CONFIG_FILE"

# Check if data-dir is specified and not empty
if [ -n "$DATA_DIR" ]; then
    echo "Checking data directory: $DATA_DIR"

    # Check if data-dir exists and is not empty
    if [ -d "$DATA_DIR" ] && [ "$(ls -A "$DATA_DIR" 2>/dev/null)" ]; then
        echo "Warning: Data directory $DATA_DIR is not empty. Skipping initialization."
        echo "OceanBase will not be initialized as the data directory contains existing data."
        exit 0
    else
        echo "Data directory $DATA_DIR is empty or does not exist. Proceeding with initialization."
    fi
else
    echo "Warning: No data-dir specified in configuration. Proceeding with initialization."
fi

# Execute the command
exec $CMD